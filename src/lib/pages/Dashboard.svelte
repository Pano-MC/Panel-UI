<!-- Dashboard Page -->
<div class="container">
  <!-- Welcome Alerts -->
  {#if data.getting_started_blocks.welcome_board}
    <div
      class="alert alert-primary bg-minecraft alert-dismissible animate__animated animate__zoomIn mb-3"
    >
      <div class="row">
        <div class="col-12 pb-3">
          <h3 class="card-title">HoÅŸ Geldiniz</h3>
          <p class="lead fw-bold">
            Pano, web sunucunuza baÅŸarÄ±yla kuruldu ve kullanÄ±ma hazÄ±r! ğŸš€
            <br />
            Ä°ÅŸte baÅŸlarken yapabilecekleriniz ğŸ‘‡:
          </p>
        </div>
        <div class="col-lg-4 mb-lg-0 mb-3">
          <h5>Sunucu BaÄŸlayÄ±n</h5>
          <p>Pano'yu oyun sunucunuza baÄŸlayÄ±n ve daha fazla yÃ¶netim Ã¶zelliklerine eriÅŸin.</p>
          <button
            class="btn btn-sm btn-primary"
            data-bs-target="#connectServer"
            data-bs-toggle="modal"
          >
            <i class="fas fa-plus mr-2"></i>
            Sunucu BaÄŸla
          </button>
        </div>
        <div class="col-lg-4 mb-lg-0 mb-3">
          <ul class="list-unstyled mb-1">
            <h5>MenÃ¼den Ã–neriler</h5>
            <li>
              <a class="alert-link" href="{base}/posts/create-post">
                <i class="fas fa-pen mr-2"></i>
                Ä°lk YazÄ±nÄ±zÄ± YayÄ±nlayÄ±n
              </a>
            </li>
            <li>
              <a class="alert-link" href="{base}/view">
                <i class="fas fa-brush mr-1"></i>
                Sitenizin GÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ Belirleyin
              </a>
            </li>
            <li>
              <a class="alert-link" href="{base}/tools">
                <i class="fas fa-tools mr-2"></i>
                AraÃ§larÄ± YÃ¶netin
              </a>
            </li>
            <li>
              <a class="alert-link" href="{base}/players">
                <i class="fas fa-user-cog mr-2"></i>
                OyuncularÄ±nÄ±zÄ± Ä°nceleyin
              </a>
            </li>
          </ul>
        </div>
        <div class="col-lg-4 mb-lg-0 mb-3">
          <ul class="list-unstyled mb-2">
            <h5>Daha FazlasÄ±</h5>
            <li>
              <a class="alert-link" href="javascript:void(0);">
                <i class="fas fa-puzzle-piece mr-2"></i>
                Pano Eklentilerini KeÅŸfedin
              </a>
            </li>
            <li>
              <a class="alert-link" href="javascript:void(0);">
                <i class="fas fa-palette mr-2"></i>
                Pano TemalarÄ±nÄ± KeÅŸfedin
              </a>
            </li>
            <li>
              <a class="alert-link" href="javascript:void(0);" target="_blank">
                <i class="fas fa-book-open mr-2"></i>
                DÃ¶kÃ¼mantasyonlarÄ± Ä°nceleyin
              </a>
            </li>
            <li>
              <a
                class="alert-link"
                href="https://panomc.com/discord"
                target="_blank"
              >
                <i class="fab fa-discord mr-2"></i>
                Discord TopluluÄŸumuza KatÄ±lÄ±n
              </a>
            </li>
          </ul>
        </div>
      </div>

      <button
        type="button"
        class="btn-close"
        data-bs-dismiss="alert"
        on:click="{onCloseGettingStartedCard}"></button>
    </div>
  {/if}

  <div
    class="row my-3 justify-content-between animate__animated animate__fadeIn"
  >
    <div class="col-auto">
      <div class="text-secondary">
        <div class="row align-items-center">
          <div class="col-auto">
            <h2 class="mb-0">12</h2>
          </div>
          <div class="col-auto">Ã‡evrimiÃ§i</div>
        </div>
      </div>
    </div>
    <div class="col-auto">
      <div class="text-warning">
        <div class="row align-items-center">
          <div class="col-auto">
            <h2 class="mb-0">
              {data.registered_player_count}
            </h2>
          </div>
          <div class="col-auto">Yeni KayÄ±t</div>
        </div>
      </div>
    </div>
    <div class="col-auto">
      <div class="text-bittersweet">
        <div class="row align-items-center">
          <div class="col-auto">
            <h2 class="mb-0">
              {data.registered_player_count}
            </h2>
          </div>
          <div class="col-auto">Toplam Oyuncu</div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <div class="row justify-content-between mb-3">
        <div class="col">
          <h5 class="card-title">Website Aktivitesi</h5>
        </div>
        <div class="col-auto">
          <div class="btn-group">
            <button class="btn btn-sm btn-outline-light btn-link active">
              HaftalÄ±k
            </button>
            <button class="btn btn-sm btn-outline-light btn-link">
              AylÄ±k
            </button>
          </div>
        </div>
      </div>
      <VisitorsChart />
    </div>
  </div>

  <!-- Latest Tickets -->
  <div class="card">
    <div class="card-body">
      <div class="row justify-content-between mb-3">
        <div class="col">
          <h5 class="card-title">Son Talepler</h5>
        </div>
        <div class="col-auto text-right">
          <a href="{base}/tickets" class="btn btn-link bg-light btn-sm">
            TÃ¼m Talepler
          </a>
        </div>
      </div>

      {#if data.tickets.length === 0}
        <div class="container text-center animate__animated animate__zoomIn">
          <i class="fas fa-ticket-alt fa-3x m-3 text-dark text-opacity-25"></i>
          <p class="text-gray">Burada iÃ§erik yok.</p>
        </div>
      {:else}
        <ul class="list-group">
          {#each data.tickets as ticket, index (ticket)}
            <a
              href="{base}/tickets/ticket/{ticket.id}"
              class="list-group-item list-group-item-action rounded d-flex flex-row"
            >
              <div class="text-primary">
                {ticket.title}
                <br />
                <small class="text-muted">
                  <b> <Date time="{ticket.last_update}" /> </b>,
                  <a href="{base}/tickets/category/{ticket.category.title}">
                    <b>{ticket.category.title}</b>
                  </a>
                  kategorisine aÃ§Ä±ldÄ±.
                </small>
              </div>
            </a>
          {/each}
        </ul>
      {/if}
    </div>
  </div>

  <!-- Statistic Table -->
  <div class="card">
    <div class="card-body">
      <h5 class="card-title">Ä°statistik</h5>
      <div class="table-responsive animate__animated animate__fadeIn">
        <table class="table table-sm m-0">
          <tbody class="text-muted">
            <tr>
              <th scope="row">YazÄ±lar:</th>
              <td>{data.post_count}</td>
            </tr>
            <tr>
              <th scope="row">Oyuncular:</th>
              <td>{data.registered_player_count}</td>
            </tr>
            <tr>
              <th scope="row">YÃ¶neticiler:</th>
              <td>?</td>
            </tr>
            <tr>
              <th scope="row">Talepler:</th>
              <td>{data.tickets_count}</td>
            </tr>
            <tr>
              <th scope="row">BaÄŸlÄ± Sunucular:</th>
              <td>?</td>
            </tr>
            <tr>
              <th scope="row">Eklentiler:</th>
              <td>?</td>
            </tr>
            <tr>
              <th scope="row">Temalar:</th>
              <td>?</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script context="module">
  import { showNetworkErrorOnCatch } from "$lib/store.js";
  import ApiUtil from "$lib/api.util.js";

  async function loadData({ request, CSRFToken }) {
    return new Promise((resolve, reject) => {
      ApiUtil.get({
        path: "/api/panel/initPage/dashboard",
        request,
        CSRFToken,
      }).then((body) => {
        if (body.result === "ok") {
          resolve(body);
        } else {
          reject(body);
        }
      });
    });
  }

  /**
   * @type {import('@sveltejs/kit').Load}
   */
  export async function load(request) {
    let output = {
      props: {
        data: {
          getting_started_blocks: {
            welcome_board: false,
          },
          registered_player_count: 0,
          post_count: 0,
          tickets_count: 0,
          open_tickets_count: 0,
          tickets: [],
        },
      },
    };

    if (request.stuff.NETWORK_ERROR) {
      output.props.data.NETWORK_ERROR = true;

      return output;
    }

    await loadData({ request }).then((body) => {
      output.props.data = { ...output.props.data, ...body };
    });

    return output;
  }
</script>

<script>
  import { base } from "$app/paths";
  import { session } from "$app/stores";
  import { pageTitle } from "$lib/store.js";

  import VisitorsChart from "$lib/component/charts/Dashboard/VisitorsChart.svelte";
  // import PlayersChart from "$lib/component/charts/Dashboard/PlayersChart.svelte";
  // import TrafficChart from "$lib/component/charts/Dashboard/TrafficChart.svelte";
  import TicketStatus from "$lib/component/TicketStatus.svelte";
  import Date from "$lib/component/Date.svelte";

  export let data;

  pageTitle.set("Ä°statistikler");

  if (data.NETWORK_ERROR) {
    showNetworkErrorOnCatch((resolve, reject) => {
      loadData({ CSRFToken: $session.CSRFToken })
        .then((body) => {
          data = { ...data, ...body };
          resolve();
        })
        .catch(() => {
          reject();
        });
    }, true);
  }

  function onCloseGettingStartedCard() {
    showNetworkErrorOnCatch((resolve, reject) => {
      ApiUtil.post({
        path: "/api/panel/dashboard/closeGettingStartedCard",
        CSRFToken: $session.CSRFToken,
      })
        .then(() => {
          resolve();
        })
        .catch(() => {
          reject();
        });
    });
  }
</script>
